<wxs module="utils">
var formatFileSize = function(size) {
  if (!size && size !== 0) return '';
  size = Number(size);
  if (isNaN(size)) return '';
  
  if (size < 1024) {
    return size + 'B';
  } else if (size < 1024 * 1024) {
    return (size / 1024).toFixed(2) + 'KB';
  } else if (size < 1024 * 1024 * 1024) {
    return (size / (1024 * 1024)).toFixed(2) + 'MB';
  } else {
    return (size / (1024 * 1024 * 1024)).toFixed(2) + 'GB';
  }
}
module.exports = {
  formatFileSize: formatFileSize
};
</wxs>

<view class="datum-container">
  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <view class="header">
    <view class="search-box">
      <input bindinput="handleSearch" placeholder="æœç´¢æ–‡ä»¶..." />
      <view class="search-icon">
        <text class="iconfont icon-search"></text>
      </view>
    </view>
    <view class="upload-btn" bindtap="handleUpload">
      <text>ä¸Šä¼ èµ„æ–™</text>
    </view>
  </view>

  <!-- åˆ†ç±»å¯¼èˆª -->
  <scroll-view scroll-x="true" class="category-nav">
    <view class="category-list">
      <view class="category-item {{currentCategory === item ? 'active' : ''}}" 
            wx:for="{{fileCategories}}" 
            wx:key="*this"
            bindtap="switchCategory"
            data-category="{{item}}">
        <text>{{item}}</text>
      </view>
    </view>
  </scroll-view>

  <!-- æ–‡ä»¶åˆ—è¡¨åŒºåŸŸ -->
  <view class="content-area">
    <!-- åˆ†ç±»æµè§ˆæ¨¡å¼ -->
    <block wx:if="{{viewMode === 'category'}}">
      <block wx:for="{{fileCategories}}" wx:key="*this" wx:for-item="category">
        <view class="file-section" wx:if="{{!currentCategory || currentCategory === category}}">
          <view class="section-header">
            <text class="section-title">{{category}}</text>
          </view>
          
          <view class="file-list">
            <block wx:if="{{categoryFiles[category] && categoryFiles[category].length > 0}}">
              <view wx:for="{{categoryFiles[category]}}" wx:key="id" class="file-card">
                <view class="file-icon {{item.type || 'application'}}"></view>
                <view class="file-content">
                  <view class="file-title">{{item.name || 'æœªå‘½åæ–‡ä»¶'}}</view>
                  <view class="file-meta">
                    <text class="file-size">{{utils.formatFileSize(item.size)}}</text>
                    <text class="file-date">{{item.createdAt ? item.createdAt.substring(0, 10) : ''}}</text>
                  </view>
                </view>
                <view class="file-actions">
                  <view class="action-btn download" bindtap="handleDownload" data-id="{{item.id}}">
                    <text class="action-icon">â†“</text>
                  </view>
                  <view wx:if="{{item.uploader.id === userInfo.id || userInfo.status === 'admin'}}" 
                        class="action-btn delete" 
                        bindtap="handleDelete" 
                        data-id="{{item.id}}">
                    <text class="action-icon">Ã—</text>
                  </view>
                </view>
              </view>
            </block>
            <view wx:else class="empty-state">
              <view class="empty-icon">ğŸ“„</view>
              <text class="empty-text">æš‚æ— {{category}}æ–‡ä»¶</text>
            </view>
          </view>
        </view>
      </block>
    </block>

    <!-- æˆ‘çš„ä¸Šä¼ æ¨¡å¼ -->
    <block wx:if="{{viewMode === 'myUploads'}}">
      <view class="file-section">
        <view class="section-header">
          <text class="section-title">æˆ‘ä¸Šä¼ çš„æ–‡ä»¶</text>
        </view>
        
        <view class="file-list">
          <block wx:if="{{myFiles.length > 0}}">
            <view wx:for="{{myFiles}}" wx:key="id" class="file-card">
              <view class="file-icon {{item.type || 'application'}}"></view>
              <view class="file-content">
                <view class="file-title">{{item.name || 'æœªå‘½åæ–‡ä»¶'}}</view>
                <view class="file-meta">
                  <text class="file-category-tag">{{item.category}}</text>
                  <text class="file-size">{{utils.formatFileSize(item.size)}}</text>
                  <text class="file-date">{{item.createdAt ? item.createdAt.substring(0, 10) : ''}}</text>
                </view>
              </view>
              <view class="file-actions">
                <view class="action-btn download" bindtap="handleDownload" data-id="{{item.id}}">
                  <text class="action-icon">â†“</text>
                </view>
                <view class="action-btn delete" bindtap="handleDelete" data-id="{{item.id}}">
                  <text class="action-icon">Ã—</text>
                </view>
              </view>
            </view>
          </block>
          <view wx:else class="empty-state">
            <view class="empty-icon">ğŸ“„</view>
            <text class="empty-text">æ‚¨è¿˜æ²¡æœ‰ä¸Šä¼ è¿‡æ–‡ä»¶</text>
          </view>
        </view>
      </view>
    </block>
  </view>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <view class="bottom-tabs">
    <view class="tab-item {{viewMode === 'category' ? 'active' : ''}}" bindtap="switchViewMode" data-mode="category">
      <view class="tab-icon">ğŸ“</view>
      <text class="tab-text">åˆ†ç±»æµè§ˆ</text>
    </view>
    <view class="tab-item {{viewMode === 'myUploads' ? 'active' : ''}}" bindtap="switchViewMode" data-mode="myUploads">
      <view class="tab-icon">ğŸ“¤</view>
      <text class="tab-text">æˆ‘çš„ä¸Šä¼ </text>
    </view>
  </view>

  <!-- ä¸Šä¼ å¼¹çª— -->
  <view class="modal {{showUploadModal ? 'show' : ''}}" wx:if="{{showUploadModal}}">
    <view class="modal-mask" bindtap="closeUploadModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ä¸Šä¼ æ–‡ä»¶</text>
        <view class="modal-close" bindtap="closeUploadModal">Ã—</view>
      </view>
      
      <view class="modal-body">
        <view class="form-group">
          <text class="form-label">é€‰æ‹©åˆ†ç±»</text>
          <picker bindchange="handleCategoryChange" value="{{categoryIndex}}" range="{{fileCategories}}" class="form-picker">
            <view class="picker-value">
              {{fileCategories[categoryIndex]}}
            </view>
          </picker>
        </view>
        
        <view class="form-group">
          <text class="form-label">æ–‡ä»¶æè¿°</text>
          <textarea bindinput="handleDescriptionInput" placeholder="è¯·è¾“å…¥æ–‡ä»¶æè¿°ï¼ˆé€‰å¡«ï¼‰" class="form-textarea"></textarea>
        </view>
        
        <view class="form-group checkbox-group">
          <checkbox bindtap="toggleExclusive" checked="{{isExclusive}}" class="form-checkbox"></checkbox>
          <text class="checkbox-label">è®¾ä¸ºä¸“å±æ–‡ä»¶ï¼ˆä»…ç®¡ç†å‘˜å’Œåˆä½œä¼™ä¼´å¯è§ï¼‰</text>
        </view>
        
        <view class="form-group file-upload">
          <button bindtap="selectFile" class="upload-button">é€‰æ‹©æ–‡ä»¶</button>
          <view wx:if="{{selectedFile}}" class="selected-file-info">
            <view class="file-icon {{selectedFile.type || 'application'}}"></view>
            <view class="file-details">
              <text class="file-name">{{selectedFile.name}}</text>
              <text class="file-size">{{utils.formatFileSize(selectedFile.size)}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button bindtap="closeUploadModal" class="btn-cancel">å–æ¶ˆ</button>
        <button bindtap="confirmUpload" class="btn-confirm" disabled="{{!selectedFile}}">ç¡®è®¤ä¸Šä¼ </button>
      </view>
    </view>
  </view>
</view>
